<style>
.ar-input{
	height: auto;
}
</style>

	<div class="ar-header">
		<i class="fa fa-star fa-2x"></i>
		<span style="font-size:28px;">&nbsp;修改文章</span>
	</div>
	<div class="ar-box editState">
		<div class="bot-fanhui">返回</div>
		<div class="bot-h">编辑页</div>
	<div class="ar-input">
		<volist name='article' id='vo'>
		<div class="ar-word">标题</div>
		<input id="aticle_title" type="text" class="nr ui-input" placeholder="请输入标题" style="width:90%;" value='{$vo.title}'>
	</div>
	<div class="ar-input" id="mainTagBox">
		<div class="ar-word">发布位置</div>
		<input type="checkbox" style="margin-left:10px;" id="zhiding" value="1" <if condition="($vo['tags']&1) neq 0"> checked="checked"</if>>&nbsp;&nbsp;<label for="zhiding">置顶</label>
		<input type="checkbox" style="margin-left:10px;" id="jingxuan" value="2" <if condition="($vo['tags']&2) neq 0"> checked="checked"</if>>&nbsp;&nbsp;<label for="jingxuan" >精选</label>
		<!--<input type="checkbox" style="margin-left:10px;" id="zuixinjianjie" value="4" <if condition="($vo['tags']&4) neq 0"> checked="checked"</if>>&nbsp;&nbsp;<label for="zuixinjianjie">最新简介</label>
		<input type="checkbox" style="margin-left:10px;" id="qiangshizhuanye" value="8" <if condition="($vo['tags']&8) neq 0"> checked="checked"</if>>&nbsp;&nbsp;<label for="qiangshizhaunye">强势专业</label>-->
		<input type="checkbox" style="margin-left:10px;" id="bangdan" value="64" <if condition="($vo['tags']&64) neq 0"> checked="checked"</if>>&nbsp;&nbsp;<label for="bangdan">榜单</label>
		<!--<input type="checkbox" style="margin-left:10px;" id="shuju" value="16" <if condition="($vo['tags']&16) neq 0"> checked="checked"</if>>&nbsp;&nbsp;<label for="shuju">就业数据</label>-->
		<input type="checkbox" style="margin-left:10px;" id="dongtai" value="32" <if condition="($vo['tags']&32) neq 0"> checked="checked"</if>>&nbsp;&nbsp;<label for="dongtai">动态</label>
	</div>
	<div class="ar-input" id="yanse" style=" <if condition="($vo['tags']&64) eq 0">display:none</if>" style="background-color:{$vo.color1};border-color: {$vo.color2};color:{$vo.color3};">
		<div class="ar-word">颜色</div>
		<input type="radio" name="color" <if condition="$vo['color1'] eq '#daeef7'">checked</if> style="margin-left:10px;" id="lanse" value="daeef7">&nbsp;&nbsp;<label for="lanse">蓝色</label>
		<input type="radio" name="color" <if condition="$vo['color1'] eq '#f4e0e1'">checked</if> style="margin-left:10px;" id="hongse" value="f4e0e1">&nbsp;&nbsp;<label for="hongse">红色</label>
		<input type="radio" name="color" <if condition="$vo['color1'] eq '#fffae4'">checked</if> style="margin-left:10px;" id="huangse" value="fffae4">&nbsp;&nbsp;<label for="huangse">黄色</label>
		<input type="radio" name="color" <if condition="$vo['color1'] eq '#e0f2da'">checked</if> style="margin-left:10px;" id="lvse" value="e0f2da">&nbsp;&nbsp;<label for="lvse">绿色</label>
	</div>

	<div class="ar-input" id="display">
		<div class="ar-word">首页显示</div>
		<input type="radio" name="xianshi" style="margin-left:10px;" id="shi" value="0" <if condition="$vo['key'] eq 0">checked="checked"</if>>&nbsp;&nbsp;<label for="shi">是</label>
		<input type="radio" name="xianshi" style="margin-left:10px;" id="fou" value="1" <if condition="$vo['key'] eq 1">checked="checked"</if>>&nbsp;&nbsp;<label for="fou">否</label>	
	</div>

	<div class="ar-input">
		<div class="ar-word">标签</div>
		<div class="ar-label tagsAutoCom" style="width:90%;">
			<div class="tagsbox">
			<volist name="vo.value" id="vo1">
			<span style="margin-left:2px;margin-top:4px;" class="lab-tag" data-type='{$vo1.type}'>{$vo1.value}<i class="fa fa-close closeicon"></i>
		    </span>
			</volist>
			</div>
			<input id="tagInput"  class="nr tagInput" type="text" placeholder="请输入其他标签" >
			<div class="taglist onlyfocus"></div>
		</div>
	</div>
	<div class="ar-input">
		<div class="ar-word">发布时间</div>
		<div style="position:relative;"><input id="dateinfo" type="text" class="datainp nr ui-input" placeholder="请输入发布时间" style="width:90%;" value="<php>echo date('Y-m-d H:i:s ',$vo['in_time']);</php>" readonly></div>

	</div>
	<div class="ar-input">
		<div class="ar-word">发布人</div>
		<input id="article_author" type="text" class="nr ui-input" placeholder="请输入发布人" style="width:90%;" value="{$vo.name}">

	</div>
	<div class="ar-input">
		<div class="ar-word">文章摘要</div>
		<textarea id="article_abstract" type="text" class="nr ui-input" placeholder="请输入文章摘要；有配图建议70字以内；无配图建议150字以内" style="width:90%;height: 150px;">{$vo.summary}</textarea>

	</div>
	<div class="ar-input">
		<div class="ar-word">配图</div>
		<input type="file" class="tianjia">
		<div class="ar-tupian">
			<if condition="$vo.photo neq null">
			<img src="{$vo.photo}" style="height: 100%;width: 100%;" />
			</if>
		</div>
		若无则不上传
	</div>
	
	<div class="ar-input">
		<div class="ar-word">正文</div>
		<script id="editor" type="text/plain" style="height: 500px;">{$vo.article_text|htmlspecialchars_decode}</script>
	</div>
	
	<div class="fabu" data-id="{$vo.id}">发布</div>
	</volist>
	
</div>

<script type="text/javascript">

//实例化编辑器
//建议使用工厂方法getEditor创建和引用编辑器实例，如果在某个闭包下引用该编辑器，直接调用UE.getEditor('editor')就能拿到相关的实例
UE.delEditor('editor')
var ue = UE.getEditor('editor',{wordCount:false});
// var ueditorcontent=ue.getContent();
$("#tagInput").width($(".tagsAutoCom").width()-$(".tagsbox").width()-7);
var result = $(".ar-tupian")[0]; 
var input = $(".tianjia")[0];

$(".bot-fanhui").click(function(){
	window.location.reload();
});
if(typeof FileReader==='undefined'){ 
    result.innerHTML = "抱歉，你的浏览器不支持 FileReader"; 
    input.setAttribute('disabled','disabled');
}
else{ 
	input.addEventListener('change',readFile,false); 
}
var imagefile;
function readFile(){ 
    var file = this.files[0]; 
    if(!/image\/\w+/.test(file.type)){ 
        alert("文件必须为图片！"); 
        return false; 
    } 
    var reader = new FileReader(); 
    reader.readAsDataURL(file);
    reader.onload = function(e){ 
        result.innerHTML = '<img style="width:250px;height:141px;" src="'+this.result+'" alt=""/>';
        imagefile = this.result.split(',')[1];
    }
}
var timeout;
$("#tagInput").bind("keyup",function(){
	var keyword = $.trim($(this).val());
	var $this = $(this);
	clearTimeout(timeout);
	if(keyword!=""){
		timeout = setTimeout(function(){
			$.when(getTagList("__ROOT__",keyword)).done(function(data){
				if(data.state==0){
					var order = data.order;
					if(order.length){
						var html = '';
						for(var i = 0; i < order.length; i++){
							html += "<div class='textline' data-type='"+order[i]["type"]+"'>"+order[i]["tags"]+"</div>";
						}
						$this.next(".taglist").empty().append(html).addClass("show");
					}
				}
				else{
					console.log(data);
				}
			});
		},300);
	}
});

$(".taglist").on("click",".textline",function(){
	var labelhtml=$('<span style="margin-left:2px;margin-top:4px;" class="lab-tag" data-type="'+$(this).attr("data-type")+'">'+
						$(this).text()+
						'<i class="fa fa-close closeicon"></i>'+
				    '</span>');
	$(".tagsbox").append(labelhtml);
	tagInputResize();
	$(this).closest(".taglist").removeClass("show").empty();
});
function tagInputResize(){
	var total = $(".tagsAutoCom").width()-8;
	var tagbox = $(".tagsbox").width();
	$("#tagInput").width(total-tagbox).val("").focus();
}
$(".tagsbox").on("click",".closeicon",function(){
	$(this).closest("span").remove();
	tagInputResize();
});

jeDate({
		dateCell:"#dateinfo",
		format:"YYYY-MM-DD hh:mm:ss",
		isinitVal:true,
		isTime:true, //isClear:false,
		minDate:"2014-09-19 00:00:00",
		okfun:function(val){alert(val)}
	})// 发布文章按钮

$(".fabu").click(function(){

	var title = $.trim($("#aticle_title").val()),
		time = $('#dateinfo').val(),
		name = $.trim($("#article_author").val()),
		text = ue.getContent(),
		summary = $.trim($("#article_abstract").val()),
		tags = 0,
		key = $('#display input:radio:checked').val(),
		value = [];
	$.each($("#mainTagBox input[type='checkbox']:checked"),function(){
		tags+=$(this).val()-0;
	});
	$.each($(".tagsAutoCom .tagsbox span"),function(){
		value.push({"tags":$(this).text(),"type":$(this).attr("data-type")});
	});
	if(title==""){
		alert("文章标题不能为空");
	}
	else if(time==""){
		alert("发表时间不能为空");
	}
	else if(name==""){
		alert("作者不能为空");
	}
	else if(text==""){
		alert("正文不能为空");
	}
	else if(summary==""){
		alert("摘要不能为空");
	}
	else if(value.length==0){
		alert("标签必填，且必须从备选列表中选择，纯文字输入无效");
	}
	else{
		//var timearray = time.split("-");
		//time = Date.parse(new Date(timearray[0],timearray[1]-1,timearray[2]))/1000;
		var data = {
				"id":$(this).attr("data-id"),
				"title":title,
				"tags":tags,
				"time":time,
				"name":name,
				"text":text,
				"value":value,
				"key":key,
				"summary":summary
			};
		// 照片
		if($(".ar-tupian img").attr("src")!=(""||undefined)){
			data["photo"]=$(".ar-tupian img").attr("src").split(',')[1];
		}
		if($("#bangdan").is(":checked")){
			var colorValue = $("input[name='color']:checked").val();
			data["color1"] = "#"+colorValue;
			data["color2"] = "#"+(("0x"+colorValue) - ("0x201008")).toString(16);
			data["color3"] = "#"+(("0x"+colorValue) - ("0xa6a6a6")).toString(16);
		}
		$.ajax({
			url: "__ROOT__/article_inputapi",
			type: "POST",
			data: data,
			success: function(data){
				if(data.state==0){
					alert("文章发布成功");
					ue.execCommand('clearlocaldata');
					window.location.reload();
				}
				else{
					alert(data.detail);
				}
			},
			error: function(){

			}
		});
	}
});



// 勾选榜单后
$("#bangdan").bind('change',function(){
	console.log($(this).prop("checked"));
	if($(this).prop("checked")){
		$("#yanse").show();
	}
	else{
		$("#yanse").hide();
	}
});
// 勾选精选后
// $("#jingxuan").bind('change',function(){
// 	if($(this).prop("checked")){
// 		$(".tagsbox").append('<span style="margin-left:2px;margin-top:4px;" class="lab-tag selectedTag" data-type="0">精选'+
// 								'<i class="fa fa-close closeicon"></i>'+
// 						    '</span>');
// 		$("#tagInput").width($("#tagInput").width()-$(".tagsbox").width()).val("").focus();
// 	}
// 	else{
// 		$(".tagsbox").find(".selectedTag").remove();
// 	}
// });
</script>
